name: "Tech Talk Phase 4: Slides"

# Phase 4 checks out the feature branch, reads the README and images,
# generates Slidev slides, and pushes to the same branch/PR.
#
# Triggered by: tech-talk:slides label added to issue
# Discovers branch via: origin/tech-talk/{topic}-{issue_number}

on:
  issues:
    types: [labeled]

jobs:
  slides:
    name: Generate Slides
    runs-on: ubuntu-latest
    if: github.event.label.name == 'tech-talk:slides'
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Extract issue fields
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            const extractField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*([^#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };

            const topic = extractField('Tech Talk Topic');
            if (!topic) {
              core.setFailed('Could not extract topic from issue');
              return;
            }

            core.setOutput('topic', topic);
            core.setOutput('primary_question', extractField('Primary Question') || 'Not specified');
            core.setOutput('audience', extractField('Target Audience') || 'Mixed Audience');
            core.setOutput('duration', extractField('Expected Duration') || '45 minutes');

      - name: Checkout feature branch
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          BRANCH_NAME="tech-talk/${TOPIC}-${{ github.event.issue.number }}"

          if git ls-remote --exit-code origin "$BRANCH_NAME" > /dev/null 2>&1; then
            git checkout "$BRANCH_NAME"
            echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
            echo "âœ… Checked out branch: $BRANCH_NAME"
          else
            echo "âŒ Branch $BRANCH_NAME not found. Run Phases 1-3 first."
            exit 1
          fi

      - name: Verify README exists
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          if [ ! -f "tech-talks/${TOPIC}/README.md" ]; then
            echo "âŒ tech-talks/${TOPIC}/README.md not found. Run Phase 3 first."
            exit 1
          fi
          echo "âœ… README found on branch ${BRANCH_NAME}"

      - name: Comment - Starting Slides
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸŽ¬ Phase 4: Slide Generation Started\n\nGenerating Slidev slides from README on branch \`${{ env.BRANCH_NAME }}\`...`
            });

      - name: Run Copilot CLI for slide generation
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"

          # Build prompt from template
          sed -e "s|{{ISSUE_NUMBER}}|${{ github.event.issue.number }}|g" \
              -e "s|{{TOPIC}}|${TOPIC}|g" \
              -e "s|{{PRIMARY_QUESTION}}|${{ steps.extract.outputs.primary_question }}|g" \
              -e "s|{{AUDIENCE}}|${{ steps.extract.outputs.audience }}|g" \
              -e "s|{{DURATION}}|${{ steps.extract.outputs.duration }}|g" \
              .github/prompts/tech-talk/slides-instructions.md > slides_prompt.txt

          # Append the README as source content
          echo "" >> slides_prompt.txt
          echo "---" >> slides_prompt.txt
          echo "## Source README Content" >> slides_prompt.txt
          cat "tech-talks/${TOPIC}/README.md" >> slides_prompt.txt

          # List available images
          echo "" >> slides_prompt.txt
          echo "## Available Images" >> slides_prompt.txt
          ls "tech-talks/${TOPIC}/images/" 2>/dev/null | grep -v '.gitkeep' >> slides_prompt.txt || echo "(none)" >> slides_prompt.txt

          # Run Copilot CLI
          copilot -p @slides_prompt.txt > "slides/tech-talks/${TOPIC}.md"

          echo "âœ… Slide generation complete"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TOPIC="${{ steps.extract.outputs.topic }}"
          git add "slides/tech-talks/${TOPIC}.md"

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Phase 4: Slides for ${TOPIC} (Issue #${{ github.event.issue.number }})"
            git push origin "$BRANCH_NAME"
          fi

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['tech-talk:complete']
            });

      - name: Post completion status
        uses: actions/github-script@v7
        with:
          script: |
            const topic = '${{ steps.extract.outputs.topic }}';
            const branch = '${{ env.BRANCH_NAME }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… Phase 4: Slides Complete\n\nðŸŽ¬ \`slides/tech-talks/${topic}.md\`\n\nPushed to branch \`${branch}\`.\n\n---\n\n**All phases complete!** Review the PR and merge when ready.`
            });
