name: Auto-assign new issues to Copilot
 
on:
  issues:
    types: [opened]

permissions:
  issues: write
 
jobs:
  assign-to-copilot: 
    runs-on: ubuntu-latest
    steps:
      - name: Assign issue to Copilot coding agent
        uses: actions/github-script@v7
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`Attempting to assign issue #${issue_number} to Copilot...`);
            
            // First, get the Copilot bot ID using GraphQL
            const suggestedActorsQuery = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                    nodes {
                      login
                      __typename
                      ... on Bot {
                        id
                      }
                    }
                  }
                }
              }
            `;
            
            const suggestedActors = await github.graphql(suggestedActorsQuery, { owner, repo });
            
            const actors = suggestedActors.repository.suggestedActors.nodes;
            console.log(`Found ${actors.length} suggested actors:`);
            actors.forEach(actor => {
              console.log(`  - ${actor.login} (${actor.__typename}) ${actor.id || '(no id)'}`);
            });
            
            // Also check assignable users separately
            try {
              const assignableUsers = await github.rest.issues.listAssignees({
                owner,
                repo,
                per_page: 100
              });
              console.log(`\nAssignable users from REST API (${assignableUsers.data.length}):`);
              assignableUsers.data.forEach(user => {
                console.log(`  - ${user.login} (${user.type})`);
              });
            } catch (e) {
              console.log('Could not fetch assignable users via REST API');
            }
            
            // Try multiple possible Copilot login names
            const copilotBot = actors.find(
              actor => actor.login === 'copilot-swe-agent' || 
                       actor.login === 'github-copilot[bot]' || 
                       actor.login.includes('copilot')
            );
            
            if (!copilotBot) {
              core.setFailed(`Copilot coding agent not found. Available actors: ${actors.map(a => a.login).join(', ')}`);
              return;
            }
            
            console.log(`Found Copilot bot with ID: ${copilotBot.id}`);
            
            // Get the issue's GraphQL ID
            const issueQuery = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    id
                    title
                  }
                }
              }
            `;
            
            const issueData = await github.graphql(issueQuery, { 
              owner, 
              repo, 
              issueNumber: issue_number 
            });
            
            const issueId = issueData.repository.issue.id;
            console.log(`Found issue with GraphQL ID: ${issueId}`);
            
            // Assign using GraphQL mutation (the ONLY way that works for bots)
            const assignMutation = `
              mutation($issueId: ID!, $actorIds: [ID!]!) {
                replaceActorsForAssignable(input: {assignableId: $issueId, actorIds: $actorIds}) {
                  assignable {
                    ... on Issue {
                      id
                      title
                      assignees(first: 10) {
                        nodes {
                          login
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const assignResult = await github.graphql(assignMutation, {
              issueId: issueId,
              actorIds: [copilotBot.id]
            });
            
            const assignees = assignResult.replaceActorsForAssignable.assignable.assignees.nodes.map(a => a.login);
            
            if (assignees.includes('copilot-swe-agent')) {
              console.log(`âœ… Successfully assigned issue #${issue_number} to Copilot coding agent`);
            } else {
              core.setFailed(`Failed to assign issue to Copilot. Assignees: ${assignees.join(', ')}`);
            }