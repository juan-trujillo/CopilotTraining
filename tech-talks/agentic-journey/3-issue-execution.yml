name: "Phase 3: Agentic Coding"

# Implement the approved plan and create PR
on:
  issue_comment:
    types: [created]

jobs:
  execution:
    name: Implement Code
    runs-on: ubuntu-latest
    # Only run when human approves plan with /approve-plan
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve-plan')
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Verify issue has planned status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Verifying issue #${{ github.event.issue.number }} is ready for execution..."

          # Check if issue has status:planned label
          LABELS=$(gh api /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels --jq '.[].name')

          if ! echo "$LABELS" | grep -q "status:planned"; then
            echo "âŒ Error: Issue must have 'status:planned' label before execution"
            exit 1
          fi

          echo "âœ… Issue is ready for execution"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Get issue and execution plan
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Fetching issue details and execution plan..."

          # Get issue details
          gh api /repos/${{ github.repository }}/issues/${{ github.event.issue.number }} > issue.json
          TITLE=$(jq -r '.title' issue.json)
          BODY=$(jq -r '.body // "No description"' issue.json)

          # Get comments to find the execution plan
          gh api /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[] | select(.body | contains("Phase 2: Execution Plan Ready")) | .body' \
            > execution_plan.txt || echo "No execution plan found" > execution_plan.txt

          echo "Issue: $TITLE"
          echo "Plan retrieved"

      - name: Acknowledge approval
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api POST /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --input - <<EOF
          {
            "body": "## ðŸ¤– Phase 3: Implementation Starting\n\nâœ… Plan approved by @${{ github.event.comment.user.login }}\n\nCopilot CLI is now implementing the approved execution plan...\n\n---\n*Automated by [agentic-journey Phase 3](https://github.com/${{ github.repository }}/tree/main/tech-talks/agentic-journey)*"
          }
          EOF

      - name: Create feature branch
        run: |
          BRANCH_NAME="copilot/issue-${{ github.event.issue.number }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Implement solution with Copilot CLI
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          echo "ðŸ”¨ Running Copilot CLI for implementation..."

          # Read issue and plan
          TITLE=$(jq -r '.title' issue.json)
          BODY=$(jq -r '.body' issue.json)
          PLAN=$(cat execution_plan.txt)

          # Load external prompt template and substitute variables
          sed -e "s|{{ISSUE_NUMBER}}|${{ github.event.issue.number }}|g" \
              -e "s|{{ISSUE_TITLE}}|${TITLE}|g" \
              -e "s|{{ISSUE_DESCRIPTION}}|${BODY}|g" \
              .github/prompts/implementation-instructions.md > implementation_instructions_base.txt

          # Append the execution plan
          echo "" >> implementation_instructions_base.txt
          echo "${PLAN}" >> implementation_instructions_base.txt
          mv implementation_instructions_base.txt implementation_instructions.txt

          # Run Copilot CLI with external instructions
          copilot -p @implementation_instructions.txt > implementation_log.txt

          echo "âœ… Implementation complete"
          cat implementation_log.txt

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage all changes
          git add .

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit with reference to issue
          git commit -m "Implement solution for issue #${{ github.event.issue.number }}

          $(cat implementation_log.txt | head -20)

          Closes #${{ github.event.issue.number }}"

      - name: Push branch
        run: |
          git push origin "$BRANCH_NAME"

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read implementation log
          IMPL_LOG=$(cat implementation_log.txt)

          # Create PR
          gh pr create \
            --title "Fix: Implement solution for issue #${{ github.event.issue.number }}" \
            --body "## Implements #${{ github.event.issue.number }}

          ### Implementation Summary

          Implemented by GitHub Copilot CLI based on approved execution plan.

          ### Changes Made

          \`\`\`
          ${IMPL_LOG}
          \`\`\`

          ### Testing

          - [ ] Unit tests passing
          - [ ] Integration tests passing
          - [ ] Manual testing completed

          ---
          *Automated by [agentic-journey Phase 3](https://github.com/${{ github.repository }}/tree/main/tech-talks/agentic-journey)*" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Update issue status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Remove planned label, add in-review label
          gh api DELETE /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels/status:planned || true

          gh api POST /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
            --input - <<EOF
          {
            "labels": ["status:in-review"]
          }
          EOF

          echo "âœ… Implementation complete - PR created"

      - name: Post completion status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api POST /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --input - <<EOF
          {
            "body": "## ðŸ¤– Phase 3: Implementation Complete\n\nâœ… Copilot CLI has implemented the solution and created a pull request.\n\n### Next Steps\n\nðŸ‘‰ Check the linked PR for the automated code review (Phase 4)\n\n---\n*Automated by [agentic-journey Phase 3](https://github.com/${{ github.repository }}/tree/main/tech-talks/agentic-journey)*"
          }
          EOF
